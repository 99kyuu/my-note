<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<title>图片懒加载</title>
	<style media="screen">
        *{ padding: 0; margin: 0; }
        li{ list-style: none;}
        img{ width: 100%; display: block;}
        #wrap{ max-width: 500px; margin: auto;}
        #wrap h2{ font-size: 28px; line-height: 50px; font-weight: 400; text-align: center;}
        .photos{ width: 100%; }
        .photos li{ margin-bottom: 20px; }
	</style>
</head>
<body>
	<div id="wrap">
		<h2>简单的图片懒加载</h2>
		<ul class="photos">
			<li><img class="lazy" src="img/loading.gif" lazy="http://skt.webgz.cn/photos/phimg.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img.bizhi.sogou.com/images/2013/12/06/436991.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img.bizhi.sogou.com/images/2015/06/26/1214905.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img.bizhi.sogou.com/images/2013/11/05/397860.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img.bizhi.sogou.com/images/2014/02/18/523326.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img0.imgtn.bdimg.com/it/u=252425940,257883462&fm=27&gp=0.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="https://img3.duitang.com/uploads/item/201505/10/20150510002613_MmRsY.jpeg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://img01.sogoucdn.com/app/a/100540002/412727.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://imgstore.cdn.sogou.com/app/a/100540002/435825.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://attachments.gfan.com/forum/attachments2/201304/24/134256oe4lamvbxm7bb2hq.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://pic1.win4000.com/wallpaper/4/5489069c8aa80.jpg" alt=""></li>
			<li><img class="lazy" src="img/loading.gif" lazy="http://www.auicss.com/demo/image/1.jpg" alt=""></li>
		</ul>
	</div>
	<script type="text/javascript">
		/**
         * 图片懒加载
         * @param {object} params 传参对象
         * @param {number} params.toBottom 距离底部像素加载开始加载（可选）
         * @param {string} params.errorImage 加载失败时显示的图片路径（可选）
         * @param {string} params.lazyAttr 自定义加载的属性（可选） 
         * @param {Function} callback 全部加载完回调（可选）
         */
        function lazyLoad(params, callback) {
            /** 懒加载属性类型 */
            let attr = params.lazyAttr || 'lazy';
            /** 距离底部距离 */
            let offset = params.toBottom || 0;
            /**
             * 加载图片
             * @param {HTMLElement} el 
             */
            function loadImage(el) { 
                /** 新建一个 img 对象去试探路径是否正确 */
                let img = new Image();
                img.src = el.getAttribute(attr);
                el.src = el.getAttribute(attr);
                el.removeAttribute(attr);
                // 图片加载失败
                img.onerror = function () {
                    el.src = params.errorImage || el.getAttribute('src');
                    el.removeAttribute(attr);
                };
            }
            /** 判断监听图片加载 */
            function judgeImages() {
                let images = document.querySelectorAll('[' + attr + ']');
                if (images.length) {
                    for (let i = 0; i < images.length; i++) {
                        if (images[i].getBoundingClientRect().top <= (window.innerHeight || document.documentElement.clientHeight) - parseInt(offset)) {
                            loadImage(images[i]);
                        }
                    }
                } else {
                    window.removeEventListener('scroll', judgeImages);
                    if (typeof callback === 'function') callback();
                }
            }
            judgeImages();
            window.addEventListener('scroll', judgeImages);
        }

        lazyLoad({
            errorImage: './img/big-1.jpg',
            lazyAttr: 'lazy',
            toBottom: 100
        }, function () {
            console.log('全部加载完成');
        });

	</script>
</body>
</html>
