<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>上传图片并预览</title>
		<style>
	        *{ padding: 0; margin: 0; }
	        .click{ display: block; width: 200px; height: 200px; background-color: #ccc; color: #fff; margin: auto; font-size: 168px; text-align: center; line-height: 200px; cursor: pointer; }
	        #file{ opacity: 0; }
	        .updataImg{ width: 500px; margin: auto; display: block; }
			.number-input{ height: 30px; margin: 0 auto 20px; display: block; box-sizing: border-box; padding: 0 12px; }
			.progress{ width: 90%; margin: 0 auto; display: block; }
		</style>
	</head>
	<body>
		<div class="img_box">
			<label for="file" class="click">+</label>
			<input type="file" id="file" name="picture" onchange="upLoad(this)" />
			<img src="" class="updataImg">
            <!-- 进度条 -->
			<input type="number" class="number-input" oninput="inputText(this)">
			<progress class="progress" value="0" max="100"></progress>
		</div>

		<script type="text/javascript">

			function upLoad(source) {
                /** 上传文件 */
                let file = source.files[0];
                /** 上传类型数组 */
                let typeStr = ['image/jpg', 'image/png', 'image/jpeg', 'image/gif'];
                // 判断文件类型
                if (typeStr.indexOf(file.type) < 0) return alert('文件格式只支持：jpg 和 png');
                /** 判断大小 */
                if (file.size > 2 * 1024 * 1024) return alert('上传的文件不能大于2M');

                // let formData = new FormData();
                // formData.append('img', file);
                // console.log(formData, file);
                
				getBase64(file, res => {
                    document.querySelector('.updataImg').src = res;
                });

				let url = getObjectURL(file);
				console.log('二进制路径', url);
			}

            /** 
             * 获取 base64
             * @param {object} _file 文件
             * @param {Function} callback 回调
            */
			function getBase64(_file, callback) {
				let reader = new FileReader();
				reader.onload = function() {
                    /** base64 路径 */
                    let src = reader.result;
                    // 转义base64: 
                    // src = src.split('+').join('%2B').split('&').join('%26');
                    if (typeof callback === 'function') callback(src);
				}
				reader.readAsDataURL(_file);
			}

            /**
             * 获取二进制路径（需要打开服务器调试）
             * @param {object} _file 文件
            */
			function getObjectURL(_file) {
				let url = null;
				if (window.createObjectURL) {
					url = window.createObjectURL(_file);
				} else if (window.URL) {
					url = window.URL.createObjectURL(_file);
				} else if (window.webkitURL) {
					url = window.webkitURL.createObjectURL(_file);
				}
				return url;
			}
			
			function inputText(el) {
				if (Number(el.value) == NaN) return;
 				document.querySelector('.progress').value = el.value
			}
		</script>
	</body>
</html>
